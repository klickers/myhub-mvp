---
import Layout from "@/layouts/Layout.astro"
import PersonaCard from "@/components/guild-hall/PersonaCard.astro"
import { Icon } from "astro-icon/components"
import { actions } from "astro:actions"
import Button from "@/components/Button.astro"
import SessionPlayButton from "@/components/models/session/SessionPlayButton"
import Tasks from "@/components/models/task/Tasks"

const contract = await Astro.callAction(actions.contract.getBySlug, {
	slug: Astro.params.slug as string,
})
if (!contract.data) return Astro.redirect("/hall")

const tasks = await Astro.callAction(actions.task.listByContract, {
	contractId: contract.data.id,
	includeSubtasks: true,
})
---

<!-- TODO: link to attached guild somewhere -->
<Layout>
	<div class="flex gap-8 min-h-screen">
		<div class="w-full">
			<div class="sticky top-8 float-right flex items-center gap-0.5">
				<!-- <a
					href="#!"
					class="inline-block p-1"
				>
					<Icon name="mingcute:play-fill" />
				</a> -->
				<SessionPlayButton
					itemType="contract"
					itemId={contract.data.id}
					client:load
				/>
				<a
					href={`/hall/contracts/${contract.data.slug}/edit`}
					class="inline-block text-white p-1 rounded-sm bg-gray-950"
				>
					<Icon name="mingcute:settings-5-fill" />
				</a>
			</div>
			<p class="mb-3 text-gray-600 text-sm flex gap-2">
				<a
					href="/hall"
					class="flex gap-1 items-center"
				>
					<Icon
						name="mingcute:building-4-fill"
						class="-mt-0.5"
					/>
					Guild Hall
				</a>
				{
					contract.data.guild ? (
						<a
							href={`/hall/guilds/${contract.data.guild.slug}`}
							class="flex gap-1 items-center"
						>
							/&nbsp;&nbsp;{contract.data.guild.name}
						</a>
					) : null
				}
			</p>
			<!-- TODO: double click to edit contract name -->
			<h1 class="mb-3">{contract.data.name}</h1>
			<p>
				{contract.data.description ?? <em>Put a description here.</em>}
			</p>
			<div class="mt-10">
				<!-- TODO: in progress, upcoming, on hold -->
				<div class="flex justify-between">
					<h2>Active Assignments</h2>
					<div>
						<Button
							href={`/hall/tasks/create?contractSlug=${contract.data.slug}`}
							icon="mingcute:plus-fill"
							label="Add Assignment"
						/>
					</div>
				</div>
				<Tasks
					tasks={tasks.data}
					client:load
				/>
			</div>
		</div>
		<div class="space-y-4 w-[260px] flex-none">
			<div class="sticky top-8"><PersonaCard /></div>
			<!-- TODO: previous sessions -->
		</div>
	</div>
	<!-- <div class="h-screen fixed right-0 top-0 w-2/5 bg-white shadow-lg p-6">
		{
			tasks.data && tasks.data.length > 0 ? (
				<div>
					<h2>{tasks.data[0].name}</h2>
					<table class="text-sm mb-6 leading-relaxed">
						<tbody>
							<tr>
								<td>Estimated Time</td>
								<td>{tasks.data[0].estimatedTime}</td>
							</tr>
							<tr>
								<td>Status</td>
								<td>{tasks.data[0].status}</td>
							</tr>
							<tr>
								<td>Deadline</td>
								<td>
									{tasks.data[0].deadline
										? format(
												tasks.data[0].deadline,
												"MMM d, yyyy"
											)
										: "no deadline"}
								</td>
							</tr>
						</tbody>
					</table>
					<div>
						<h3 class="text-lg font-semibold mb-3">Subtasks</h3>
						<Subtasks
							client:load
							taskId={tasks.data[0].id}
						/>
					</div>
				</div>
			) : null
		}
	</div> -->
</Layout>
