---
import Layout from "@/layouts/Layout.astro"
import crypto from "crypto"

const APP_PASSWORD = import.meta.env.APP_PASSWORD
const APP_SECRET = import.meta.env.APP_SECRET
const TOKEN_TTL_SECONDS = 60 * 60 * 24 * 90 // 90 days

function makeToken(password: string) {
	const ts = Math.floor(Date.now() / 1000)
	const payload = `${ts}:${password}`
	const hmac = crypto
		.createHmac("sha256", APP_SECRET)
		.update(payload)
		.digest("base64url")
	return `${Buffer.from(String(ts)).toString("base64url")}.${hmac}`
}

if (Astro.request.method === "POST") {
	try {
		const data = await Astro.request.formData()
		const entered = data.get("password")
		if (entered === APP_PASSWORD) {
			const token = makeToken(entered as string)
			Astro.cookies.set("auth", token, {
				path: "/",
				httpOnly: true,
				secure: true,
				sameSite: "lax",
				maxAge: TOKEN_TTL_SECONDS,
			})
			return Astro.redirect("/")
		}
	} catch (error) {
		if (error instanceof Error) console.error(error.message)
	}
}
---

<Layout>
	<form
		method="POST"
		action="/login"
		class="flex flex-col gap-4 max-w-sm mx-auto"
	>
		<input
			type="password"
			name="password"
			placeholder="Password"
			required
			class="border py-2 px-4 w-full"
			autofocus
		/>
		<button
			type="submit"
			class="bg-black text-white font-semibold py-2 px-4"
		>
			Login
		</button>
	</form>
</Layout>
