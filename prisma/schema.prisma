generator client {
    provider   = "prisma-client"
    output     = "../src/generated/prisma"
    engineType = "client"
}

datasource db {
    provider  = "postgresql"
    url       = env("DATABASE_URL")
    directUrl = env("DIRECT_URL")
}

// ================================================
// Adventure Schema
// ================================================

model Guild {
    id          Int     @id @default(autoincrement())
    name        String
    slug        String  @unique
    description String?
    status      Status  @default(inprogress)
    personaId   Int?

    persona   Persona?   @relation(fields: [personaId], references: [id])
    contracts Contract[]
}

model Persona {
    id          Int     @id @default(autoincrement())
    name        String
    description String
    image       String?

    guilds Guild[]
}

model Contract {
    id          Int      @id @default(autoincrement())
    name        String
    slug        String   @unique
    description String?
    dueDate     DateTime
    status      Status   @default(inprogress)
    guildId     Int?

    guild Guild? @relation(fields: [guildId], references: [id])
    tasks Task[]
}

// ================================================
// Previous Schema
// ================================================

model Bucket {
    id    Int    @id @default(autoincrement())
    name  String
    slug  String @unique
    order Int

    objectives Objective[]
}

model Objective {
    id        Int       @id @default(autoincrement())
    bucketId  Int
    name      String
    slug      String    @unique
    startDate DateTime?
    dueDate   DateTime?
    status    Status    @default(notstarted)

    bucket       Bucket        @relation(fields: [bucketId], references: [id])
    sessions     Session[]
    timePerWeeks TimePerWeek[]
}

model Task {
    id            Int            @id @default(autoincrement())
    name          String
    parentType    TaskParentType @default(contract)
    status        Status         @default(notstarted)
    estimatedTime Int?           @default(0) // in minutes
    deadline      DateTime?

    contractId   Int?
    experimentId Int?
    parentTaskId Int?

    contract   Contract?   @relation(fields: [contractId], references: [id])
    experiment Experiment? @relation(fields: [experimentId], references: [id])
    parentTask Task?       @relation("TaskHierarchy", fields: [parentTaskId], references: [id])
    subtasks   Task[]      @relation("TaskHierarchy")

    sessions Session[]
}

model Week {
    id         Int @id @default(autoincrement())
    year       Int
    weekNumber Int

    timePerWeeks TimePerWeek[]

    @@unique([year, weekNumber])
}

model TimePerWeek {
    id            Int      @id @default(autoincrement())
    year          Int
    weekNumber    Int
    itemType      ItemType @default(objective)
    objectiveId   Int?
    scheduledTime Int      @default(0)
    completed     Boolean  @default(false)

    objective Objective? @relation(fields: [objectiveId], references: [id])
    week      Week       @relation(fields: [year, weekNumber], references: [year, weekNumber])

    @@unique([year, weekNumber, itemType, objectiveId])
}

model Session {
    id          Int       @id @default(autoincrement())
    itemType    ItemType  @default(objective)
    objectiveId Int?
    taskId      Int?
    startTime   DateTime
    endTime     DateTime?
    notes       String?
    notesJson   Json?

    objective Objective? @relation(fields: [objectiveId], references: [id])
    task      Task?      @relation(fields: [taskId], references: [id])
}

model KeyValue {
    key   String @id
    value String
}

model GoogleCalendarId {
    id   String  @id
    name String?
}

model BusinessHours {
    id         Int    @id @default(autoincrement())
    daysOfWeek Int[]
    startTime  String
    endTime    String
}

enum Status {
    notstarted
    archived
    inprogress
    onhold
    completed
}

enum ItemType {
    bucket
    objective
    task
}

enum TaskParentType {
    none
    contract
    experiment
    task
}
